From daefa1584a0c1f8c4bc6fbc33d7c46a064f845d0 Mon Sep 17 00:00:00 2001
From: "Ethan D. Twardy" <ethan.twardy@gmail.com>
Date: Tue, 4 Nov 2025 21:23:10 -0600
Subject: [PATCH 1/2] dovecot: Include dovecot-config in dovecot-dev

This tool is used by dovecot plugins (e.g. pigeonhole) to locate and
build against dovecot libraries.
---
 .../recipes-support/dovecot/dovecot_2.4.1-4.bb  | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/meta-networking/recipes-support/dovecot/dovecot_2.4.1-4.bb b/meta-networking/recipes-support/dovecot/dovecot_2.4.1-4.bb
index 40cf991ae1..201b16de66 100644
--- a/meta-networking/recipes-support/dovecot/dovecot_2.4.1-4.bb
+++ b/meta-networking/recipes-support/dovecot/dovecot_2.4.1-4.bb
@@ -52,7 +52,10 @@ SYSTEMD_SERVICE:${PN} = "dovecot.service dovecot.socket"
 SYSTEMD_AUTO_ENABLE = "disable"
 
 do_install:append () {
-    rm -rf ${D}${libdir}/dovecot/dovecot-config
+    sed -e "s/-f\(debug\|macro\|file\)-prefix-map=[^[:space:]]*//g" \
+        -e "s@-I${RECIPE_SYSROOT}@-I@g" \
+        -i ${D}${libdir}/dovecot/dovecot-config
+
     install -d 755 ${D}/etc/dovecot
     chmod 644 ${D}/etc/dovecot/dovecot.conf
     touch ${D}/etc/dovecot/ssl-key.pem
@@ -67,6 +70,15 @@ do_install:append () {
     oe_multilib_header dovecot/config.h
 }
 
+SYSROOT_PREPROCESS_FUNCS += "dovecot_sysroot_preprocess"
+dovecot_sysroot_preprocess () {
+    install -Dm755 ${D}${libdir}/dovecot/dovecot-config -t ${SYSROOT_DESTDIR}${libdir}/dovecot
+    sed -e "s@^LIBDOVECOT='-L${libdir}@LIBDOVECOT='-L${RECIPE_SYSROOT}${libdir}@" \
+        -e "/^LIBDOVECOT_LDA/d" \
+        -e "s@-I${includedir}@-I${RECIPE_SYSROOT}${includedir}@" \
+        -i ${SYSROOT_DESTDIR}${libdir}/dovecot/dovecot-config
+}
+
 USERADD_PACKAGES = "${PN}"
 USERADD_PARAM:${PN} = "-r -d ${libexecdir} -M -s ${base_sbindir}/nologin -g dovecot dovecot; \
                       -r -d ${libexecdir} -M -s ${base_sbindir}/nologin -g dovenull dovenull"
@@ -76,7 +88,8 @@ FILES:${PN} += "${libdir}/dovecot/*plugin.so \
                 ${libdir}/dovecot/libfs_compress.so \
                 ${libdir}/dovecot/libssl_iostream_openssl.so"
 FILES:${PN}-staticdev += "${libdir}/dovecot/*/*.a"
-FILES:${PN}-dev += "${libdir}/dovecot/libdovecot*.so"
+FILES:${PN}-dev += "${libdir}/dovecot/libdovecot*.so \
+                ${libdir}/dovecot/dovecot-config"
 FILES:${PN}-dbg += "${libdir}/dovecot/*/.debug"
 
 CVE_STATUS[CVE-2016-4983] = "not-applicable-platform: Affects only postinstall script on specific distribution."
-- 
2.47.2

